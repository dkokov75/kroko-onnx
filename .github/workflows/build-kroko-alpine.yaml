name: build-kroko-complete-bundle

on:
  workflow_dispatch:

jobs:
  build-all:
    name: Full Alpine x64 Build
    runs-on: ubuntu-latest
    container:
      image: alpine:3.19
    
    steps:
      - name: Install All Tools
        run: |
          apk update
          apk add --no-cache \
            build-base cmake git bash alsa-lib-dev \
            portaudio-dev linux-headers zlib-dev icu-dev \
            openssl-dev tar gzip python3 python3-dev py3-pip

      - name: Checkout
        uses: actions/checkout@v4

      - name: Build C++ and Python
        shell: bash
        run: |
          # 1. Musl Fix & Patches
          echo '#include <sys/stat.h>' > /tmp/musl_fix.h
          echo 'static inline int __xstat64(int v, const char* p, struct stat* s) { return stat(p, s); }' >> /tmp/musl_fix.h
          
          mkdir build && cd build
          cmake .. -DSHERPA_ONNX_ENABLE_PYTHON=ON || true
          find _deps -name "text-utils.h" -exec sed -i '1s/^/#include <cstdint>\n/' {} +
          
          # 2. Build
          export CFLAGS="-include /tmp/musl_fix.h"
          export CXXFLAGS="-include cstdint -include /tmp/musl_fix.h"
          cmake -DCMAKE_BUILD_TYPE=Release -DSHERPA_ONNX_LINK_LIBSTDCPP_STATICALLY=OFF ..
          make -j$(nproc)
          
          # 3. Python Wheel
          cd ..
          pip install wheel setuptools --break-system-packages
          python3 setup.py bdist_wheel

      - name: Create APK and TAR.GZ
        shell: bash
        run: |
          # Подготовка на структурата
          mkdir -p dist/pkg/usr/local/bin
          cp build/bin/* dist/pkg/usr/local/bin/
          
          # КОРИГИРАНО: .PKGINFO трябва да е ФАЙЛ, а не папка
          cat <<EOF > dist/pkg/.PKGINFO
          pkgname = kroko-onnx-full
          pkgver = 1.0.0-r0
          pkgdesc = Full Kroko Suite for Alpine
          url = https://github.com
          builddate = $(date +%s)
          packager = GitHub-Actions
          size = $(du -sb dist/pkg/usr | cut -f1)
          arch = x86_64
          depend = alsa-lib portaudio openssl icu-libs zlib libstdc++
          EOF

          # Пакетиране
          tar -czvf kroko-full-alpine.tar.gz -C dist/pkg usr/
          tar -C dist/pkg -czvf kroko-onnx-1.0.0-r0.apk .PKGINFO usr/
          
          # Подготовка на Wheel за артефактите
          mv dist/*.whl . || true

      - name: Upload Everything
        uses: actions/upload-artifact@v4
        with:
          name: kroko-complete-distribution
          path: |
            *.tar.gz
            *.apk
            *.whl
