name: build-kroko-complete-bundle

on:
  workflow_dispatch:

jobs:
  build-all:
    name: Full Alpine x64 Build
    runs-on: ubuntu-latest
    container:
      image: alpine:3.19
    
    steps:
      - name: Install All Tools
        run: |
          apk update
          apk add --no-cache \
            build-base cmake git bash alsa-lib-dev \
            portaudio-dev linux-headers zlib-dev icu-dev \
            openssl-dev tar gzip python3 python3-dev py3-pip

      - name: Checkout
        uses: actions/checkout@v4

      - name: Apply Fixes
        shell: bash
        run: |
          # 1. Musl Fix за __xstat64
          cat <<EOF > /tmp/musl_fix.h
          #include <sys/stat.h>
          #ifdef __cplusplus
          extern "C" {
          #endif
          static inline int __xstat64(int v, const char* p, struct stat* s) { return stat(p, s); }
          #ifdef __cplusplus
          }
          #endif
          EOF

          # 2. Глобално инжектиране на cstdint (насила във всички файлове)
          # Това гарантира, че int32_t ще е наличен навсякъде
          find . -type f \( -name "*.h" -o -name "*.cc" -o -name "*.cpp" \) -exec sed -i '1i #include <cstdint>' {} +

      - name: Build C++ Binaries
        shell: bash
        run: |
          mkdir build && cd build
          # Изрично подаваме флаговете тук
          export CFLAGS="-include /tmp/musl_fix.h"
          export CXXFLAGS="-include /tmp/musl_fix.h"
          
          cmake -DCMAKE_BUILD_TYPE=Release \
                -DSHERPA_ONNX_LINK_LIBSTDCPP_STATICALLY=OFF \
                -DSHERPA_ONNX_ENABLE_PYTHON=OFF \
                -DSHERPA_ONNX_ENABLE_WEBSOCKET=ON ..
          make -j$(nproc)

      - name: Build Python Wheel
        shell: bash
        run: |
          pip install wheel setuptools --break-system-packages
          # Тук също налагаме флаговете
          CFLAGS="-include /tmp/musl_fix.h" CXXFLAGS="-include /tmp/musl_fix.h" python3 setup.py bdist_wheel

      - name: Create Packages (.tar.gz and .apk)
        shell: bash
        run: |
          # Създаваме структура за архива
          mkdir -p bundle/bin
          cp build/bin/* bundle/bin/
          tar -czvf kroko-binaries.tar.gz -C bundle bin/

          # Създаваме структура за APK
          mkdir -p apk_root/usr/local/bin
          cp build/bin/* apk_root/usr/local/bin/
          
          # Внимателно създаваме .PKGINFO като ФАЙЛ
          cat <<EOF > apk_root/.PKGINFO
          pkgname = kroko-onnx-full
          pkgver = 1.0.0-r0
          pkgdesc = Full Kroko Suite for Alpine
          url = https://github.com
          builddate = $(date +%s)
          packager = GitHub-Actions
          size = $(du -sb apk_root/usr | cut -f1)
          arch = x86_64
          depend = alsa-lib portaudio openssl icu-libs zlib libstdc++
          EOF

          tar -C apk_root -czvf kroko-onnx-1.0.0-r0.apk .PKGINFO usr/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kroko-final-dist
          path: |
            *.tar.gz
            *.apk
            dist/*.whl
