name: build-kroko-complete-bundle

on:
  workflow_dispatch:

jobs:
  build-all:
    name: Full Alpine x64 Build
    runs-on: ubuntu-latest
    container:
      image: alpine:3.19
    
    steps:
      - name: Install All Tools
        run: |
          apk update
          apk add --no-cache \
            build-base cmake git bash alsa-lib-dev \
            portaudio-dev linux-headers zlib-dev icu-dev \
            openssl-dev tar gzip python3 python3-dev py3-pip

      - name: Checkout
        uses: actions/checkout@v4

      - name: Apply Hard Patches
        shell: bash
        run: |
          # 1. Глобално инжектиране на <cstdint> във всички критични файлове
          # Това решава проблема с int32_t/int64_t веднъж завинаги
          find . -name "*.h" -o -name "*.cc" -o -name "*.cpp" | x86_64-alpine-linux-musl-grep -l "int32_t\|int64_t" | xargs sed -i '1i #include <cstdint>' || true

          # 2. Musl Fix за __xstat64
          cat <<EOF > /tmp/musl_fix.h
          #include <sys/stat.h>
          #ifdef __cplusplus
          extern "C" {
          #endif
          static inline int __xstat64(int v, const char* p, struct stat* s) { return stat(p, s); }
          #ifdef __cplusplus
          }
          #endif
          EOF

      - name: Build C++ and Python
        shell: bash
        run: |
          # Подготовка на зависимостите (за да пачнем и тях)
          mkdir build && cd build
          cmake .. -DSHERPA_ONNX_ENABLE_PYTHON=ON || true
          find _deps -name "*.h" | xargs sed -i '1i #include <cstdint>' || true
          
          # Основна компилация
          export CFLAGS="-include /tmp/musl_fix.h"
          export CXXFLAGS="-include /tmp/musl_fix.h"
          cmake -DCMAKE_BUILD_TYPE=Release \
                -DSHERPA_ONNX_LINK_LIBSTDCPP_STATICALLY=OFF \
                -DSHERPA_ONNX_ENABLE_PYTHON=ON \
                -DSHERPA_ONNX_ENABLE_WEBSOCKET=ON ..
          make -j$(nproc)
          
          # Python Wheel
          cd ..
          pip install wheel setuptools --break-system-packages
          # Подаваме флаговете и тук за всеки случай
          CFLAGS="-include /tmp/musl_fix.h" CXXFLAGS="-include /tmp/musl_fix.h" python3 setup.py bdist_wheel

      - name: Create APK and TAR.GZ
        shell: bash
        run: |
          mkdir -p dist/pkg/usr/local/bin
          cp build/bin/* dist/pkg/usr/local/bin/ || true
          
          # Описание на APK пакета
          cat <<EOF > dist/pkg/.PKGINFO
          pkgname = kroko-onnx-full
          pkgver = 1.0.0-r0
          pkgdesc = Full Kroko Suite for Alpine
          url = https://github.com
          builddate = $(date +%s)
          packager = GitHub-Actions
          size = $(du -sb dist/pkg/usr | cut -f1)
          arch = x86_64
          depend = alsa-lib portaudio openssl icu-libs zlib libstdc++
          EOF

          # Създаване на архивите
          tar -czvf kroko-full-alpine.tar.gz -C dist/pkg usr/
          tar -C dist/pkg -czvf kroko-onnx-1.0.0-r0.apk .PKGINFO usr/
          mv dist/*.whl . || true

      - name: Upload Everything
        uses: actions/upload-artifact@v4
        with:
          name: kroko-complete-distribution
          path: |
            *.tar.gz
            *.apk
            *.whl
