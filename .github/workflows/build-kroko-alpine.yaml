name: build-kroko-alpine-full-dist

on:
  workflow_dispatch:

jobs:
  build-binaries:
    name: Alpine x64 Full Build
    runs-on: ubuntu-latest
    container:
      image: alpine:3.19
    
    steps:
      - name: Install Build Tools
        run: |
          apk update
          apk add --no-cache \
            build-base cmake git bash alsa-lib-dev \
            portaudio-dev linux-headers zlib-dev icu-dev \
            openssl-dev tar gzip

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Apply Musl Fixes
        shell: bash
        run: |
          # 1. Фикс за __xstat64 (за да работи onnxruntime в Alpine)
          cat <<EOF > /tmp/musl_fix.h
          #include <sys/stat.h>
          #ifdef __cplusplus
          extern "C" {
          #endif
          static inline int __xstat64(int v, const char* p, struct stat* s) { return stat(p, s); }
          #ifdef __cplusplus
          }
          #endif
          EOF

          # 2. Глобално инжектиране на cstdint (за int32_t/int64_t грешките)
          find . -type f \( -name "*.h" -o -name "*.cc" -o -name "*.cpp" \) -exec sed -i '1i #include <cstdint>' {} +

      - name: Build All C++ Binaries
        shell: bash
        run: |
          mkdir build && cd build
          
          export CFLAGS="-include /tmp/musl_fix.h"
          export CXXFLAGS="-include /tmp/musl_fix.h"
          
          # Изключваме Python, за да не се чупи билда
          cmake -DCMAKE_BUILD_TYPE=Release \
                -DSHERPA_ONNX_LINK_LIBSTDCPP_STATICALLY=OFF \
                -DSHERPA_ONNX_ENABLE_PYTHON=OFF \
                -DSHERPA_ONNX_ENABLE_WEBSOCKET=ON ..
          
          # Пачваме зависимостите, които CMake току-що изтегли
          find _deps -name "*.h" -exec sed -i '1i #include <cstdint>' {} + || true
          
          make -j$(nproc)

      - name: Create Packages (TAR.GZ and APK)
        shell: bash
        run: |
          # Подготовка на папката за пакетиране
          mkdir -p kroko-dist/usr/local/bin
          
          # Копираме ВСИЧКО от bin директорията
          cp build/bin/* kroko-dist/usr/local/bin/
          
          # 1. СЪЗДАВАНЕ НА TAR.GZ
          tar -czvf kroko-onnx-full-alpine-x64.tar.gz -C kroko-dist usr/

          # 2. СЪЗДАВАНЕ НА APK ПАКЕТ
          # .PKGINFO трябва да е файл в корена на архива
          cat <<EOF > kroko-dist/.PKGINFO
          pkgname = kroko-onnx-full
          pkgver = 1.0.0-r0
          pkgdesc = Full Kroko ONNX ASR Suite for Alpine Musl
          url = https://github.com
          builddate = $(date +%s)
          packager = GitHub-Actions
          size = $(du -sb kroko-dist/usr | cut -f1)
          arch = x86_64
          depend = alsa-lib portaudio openssl icu-libs zlib libstdc++
          EOF

          # Пакетираме .apk файла
          tar -C kroko-dist -czvf kroko-onnx-full-1.0.0-r0.apk .PKGINFO usr/

      - name: Upload Final Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kroko-full-dist-alpine
          path: |
            *.tar.gz
            *.apk
