name: build-musl-wheel-x64

on:
  workflow_dispatch:

jobs:
  build-musl-wheel:
    name: Alpine x64 Build
    runs-on: ubuntu-latest
    container:
      image: alpine:latest
    
    steps:
      # 1. Critical: Install nodejs and tools BEFORE checkout
      - name: Install System Bootstraps
        run: |
          apk update
          apk add --no-cache nodejs tar gzip bash git build-base cmake python3 python3-dev py3-pip linux-headers

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update version
        shell: bash
        run: |
          chmod +x new-release.sh
          ./new-release.sh

      - name: Prepare Python Build Tools
        shell: bash
        run: |
          python3 -m venv /opt/venv
          . /opt/venv/bin/activate
          pip install --upgrade pip setuptools wheel

      - name: Build Wheel
        shell: bash
        run: |
          . /opt/venv/bin/activate
          # Explicitly set C++ flags for musl compatibility if needed
          export CFLAGS="-D_GNU_SOURCE"
          export CXXFLAGS="-D_GNU_SOURCE"
          export SHERPA_ONNX_MAKE_ARGS="-j$(nproc) VERBOSE=1"
          
          python3 setup.py bdist_wheel

      - name: Fix Tags & Upload
        shell: bash
        run: |
          cd dist
          # Rename to musllinux so pip knows it's for Alpine
          for f in *linux_x86_64.whl; do
            mv "$f" "${f/linux_x86_64/musllinux_1_1_x86_64}"
          done
          ls -lh

      - uses: actions/upload-artifact@v4
        with:
          name: wheel-alpine-x64
          path: ./dist/*.whl
